import{j as e,a5 as ne,ae as ie,af as de,ag as o}from"./ui-vendor-Dho0S5x9.js";import{a as l,u as ce}from"./react-vendor-ByNQKlCH.js";import{C as R,a as O,b as z,d as V}from"./card-C7BQZI4A.js";import{T as $}from"./table-DNDMFJuf.js";import{S as q}from"./skeleton-XnDLFZGi.js";import{E as oe}from"./error-message-D3zDD8H-.js";import{s as h}from"./superadminApi-Bjf7uKUS.js";import{B as r}from"./index-DMYsCFYG.js";import{I as U}from"./input-DM7v_Vsi.js";import{B as K}from"./badge-C0YrEax5.js";import{D as me,b as xe,c as he,d as pe,e as ue}from"./dialog-A3DPpc4l.js";import{S as je,a as ge,b as fe,c as ye,d as Ne}from"./select-DacTrhsM.js";import{f as T}from"./index-CgIdLkdF.js";import"./utils-vendor-Dq7h7Pqt.js";import"./query-vendor-Br3W6GMP.js";const be=20,we=["BOOKED","CANCELLED","COMPLETED"],Re=()=>{const[p,Q]=l.useState([]),[Z,C]=l.useState(!1),[D,I]=l.useState(null),[n,u]=l.useState(1),[E,_]=l.useState(1),[a,f]=l.useState({dateFrom:"",dateTo:"",routeId:"",userId:"",status:""}),[y,G]=l.useState(null),[i,B]=l.useState(null),[J,d]=l.useState(!1),[N,b]=l.useState(""),[A,F]=l.useState(!1),[w,j]=l.useState(!1),[v,M]=l.useState(null),P=ce(),c=l.useCallback(async()=>{C(!0),I(null);try{const s={page:n,limit:be,...a.dateFrom&&{dateFrom:a.dateFrom},...a.dateTo&&{dateTo:a.dateTo},...a.routeId&&{routeId:Number(a.routeId)},...a.userId&&{userId:Number(a.userId)},...a.status&&{status:a.status}},t=await h.getPaginatedTickets(s);Q(t.data.tickets),_(t.data.totalPages)}catch(s){I(s instanceof Error?s.message:"Failed to load tickets")}finally{C(!1)}},[n,a]);l.useEffect(()=>{c()},[c,n]),l.useEffect(()=>{const t=new URLSearchParams(P.search).get("userId");t&&f(x=>({...x,userId:t}))},[P.search]);const W=Array.from(p.flatMap(s=>s.bookings.map(t=>t.schedule?.route)).filter(s=>!!s).reduce((s,t)=>s.set(t.id,t),new Map).values()),X=Array.from(p.flatMap(s=>s.bookings.map(t=>t.user)).filter(s=>!!s).reduce((s,t)=>s.set(t.id,t),new Map).values()),Y=Array.from(new Set(p.flatMap(s=>s.bookings.map(t=>t.status)).filter(s=>!!s))),k=s=>{f(t=>({...t,[s.target.name]:s.target.value})),u(1)},L=s=>{f(t=>({...t,[s.target.name]:s.target.value})),u(1)},ee=async s=>{G(s),d(!0),B(null);try{const t=await h.getTicketById(s);B(t.data),b(t.data.bookings?.[0]?.status||"")}catch{o.error("Failed to load ticket details"),d(!1)}},se=async()=>{if(!(!y||!N||!v)){F(!0);try{await h.updateBookingStatus(v,{status:N,reason:"Status updated by admin"}),o.success("Booking status updated"),d(!1),c()}catch{o.error("Failed to update booking status")}finally{F(!1)}}},te=async s=>{if(window.confirm("Are you sure you want to cancel this seat booking?")){j(!0);try{await h.cancelBooking(s),o.success("Booking cancelled"),d(!1),c()}catch{o.error("Failed to cancel booking")}finally{j(!1)}}},ae=async()=>{if(y&&window.confirm("Are you sure you want to delete this ticket? This will cancel all seat bookings. This cannot be undone.")){j(!0);try{await h.deleteTicket(y),o.success("Ticket deleted"),d(!1),c()}catch{o.error("Failed to delete ticket")}finally{j(!1)}}},m=new Map;p.forEach(s=>{if(!m.has(s.ticketNumber))m.set(s.ticketNumber,{...s});else{const t=m.get(s.ticketNumber);t.bookings=[...t.bookings,...s.bookings],m.set(s.ticketNumber,t)}});const H=Array.from(m.values());return e.jsx("div",{className:"w-full min-h-screen bg-gradient-to-br from-white to-teal-50",children:e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 mb-6",children:"Tickets"}),e.jsxs(R,{children:[e.jsx(O,{children:e.jsx(z,{children:"Filters"})}),e.jsx(V,{children:e.jsxs("div",{className:"flex flex-wrap gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"Date From"}),e.jsx(U,{type:"date",name:"dateFrom",value:a.dateFrom,onChange:L})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"Date To"}),e.jsx(U,{type:"date",name:"dateTo",value:a.dateTo,onChange:L})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"Route"}),e.jsxs("select",{name:"routeId",value:a.routeId,onChange:k,className:"border rounded px-2 py-1",children:[e.jsx("option",{value:"",children:"All"}),W.map(s=>e.jsxs("option",{value:s.id,children:[s.origin," - ",s.destination]},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"User"}),e.jsxs("select",{name:"userId",value:a.userId,onChange:k,className:"border rounded px-2 py-1",children:[e.jsx("option",{value:"",children:"All"}),X.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.email,")"]},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"Status"}),e.jsxs("select",{name:"status",value:a.status,onChange:k,className:"border rounded px-2 py-1",children:[e.jsx("option",{value:"",children:"All"}),Y.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsx(r,{onClick:c,variant:"outline",children:"Apply"})]})})]}),D&&e.jsx(oe,{message:D,onRetry:c}),e.jsxs(R,{children:[e.jsx(O,{children:e.jsx(z,{children:"Tickets"})}),e.jsxs(V,{children:[Z?e.jsx(q,{className:"h-8 w-full"}):H.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No tickets found"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs($,{className:"min-w-[900px] border-separate border-spacing-y-2 border-spacing-x-4 rounded-xl bg-white shadow-md",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Ticket No"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Booking Date"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Departure Date"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"From - To"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Customer Name"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Customer Contact"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Booked Seats"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Actions"})]})}),e.jsx("tbody",{children:H.map(s=>{const t=s.bookings[0],x=t?.schedule,S=x?.route,g=t?.user,le=s.bookings.map(re=>re.seat?.seatNumber).filter(Boolean).join(", ");return e.jsxs("tr",{className:"even:bg-gray-50 hover:bg-teal-50 transition-colors rounded-xl",children:[e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:s.ticketNumber}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:t?T(new Date(t.createdAt),"yyyy-MM-dd HH:mm"):"-"}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:x?T(new Date(x.departure),"yyyy-MM-dd HH:mm"):"-"}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:S?`${S.origin} - ${S.destination}`:"-"}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:g?g.name:"-"}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:g?g.phoneNumber:"-"}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:le||"-"}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:e.jsx(K,{children:t?.status||"-"})}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:e.jsxs(r,{size:"sm",variant:"outline",onClick:()=>ee(s.id),children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),"View"]})})]},s.id)})})]})}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx(r,{size:"sm",variant:"outline",disabled:n===1,onClick:()=>u(n-1),children:"Previous"}),e.jsxs("span",{className:"px-2 py-1",children:["Page ",n," of ",E]}),e.jsx(r,{size:"sm",variant:"outline",disabled:n===E,onClick:()=>u(n+1),children:"Next"})]})]})]}),e.jsx(me,{open:J,onOpenChange:d,children:e.jsxs(xe,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(he,{children:e.jsxs(pe,{children:["Ticket Details - ",i?.ticketNumber]})}),i?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Ticket Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Ticket Number:"})," ",i.ticketNumber]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Seats:"})," ",i.bookings.length]}),i.qrCode&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"font-medium",children:"QR Code:"}),e.jsx("img",{src:i.qrCode,alt:"QR Code",className:"w-32 h-32 border rounded mt-2"})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Booked Seats"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs($,{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"Seat"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Status"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Customer"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Route"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Departure"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Payment"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Actions"})]})}),e.jsx("tbody",{children:i.bookings.map(s=>e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2",children:s.seat?.seatNumber||"-"}),e.jsx("td",{className:"px-4 py-2",children:e.jsx(K,{children:s.status})}),e.jsxs("td",{className:"px-4 py-2",children:[s.user?.name||"-",e.jsx("br",{}),e.jsx("span",{className:"text-xs text-gray-500",children:s.user?.phoneNumber||"-"})]}),e.jsx("td",{className:"px-4 py-2",children:s.schedule?.route?`${s.schedule.route.origin} â†’ ${s.schedule.route.destination}`:"-"}),e.jsx("td",{className:"px-4 py-2",children:s.schedule?.departure?T(new Date(s.schedule.departure),"yyyy-MM-dd HH:mm"):"-"}),e.jsx("td",{className:"px-4 py-2",children:s.payment?e.jsxs("div",{children:[e.jsxs("div",{children:["Rs. ",s.payment.amount]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[s.payment.method," -"," ",s.payment.status]})]}):"-"}),e.jsx("td",{className:"px-4 py-2",children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx(r,{size:"sm",variant:"outline",onClick:()=>{M(s.id),b(s.status)},children:e.jsx(ie,{className:"h-3 w-3"})}),e.jsx(r,{size:"sm",variant:"destructive",onClick:()=>te(s.id),disabled:w,children:e.jsx(de,{className:"h-3 w-3"})})]})})]},s.id))})]})})]}),v&&e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Edit Booking Status"}),e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-xs mb-1",children:"Status"}),e.jsxs(je,{value:N,onValueChange:b,children:[e.jsx(ge,{children:e.jsx(fe,{placeholder:"Select status"})}),e.jsx(ye,{children:we.map(s=>e.jsx(Ne,{value:s,children:s},s))})]})]}),e.jsx(r,{onClick:se,disabled:A,children:A?"Saving...":"Save Status"})]})]}),e.jsxs("div",{className:"bg-red-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold mb-2 text-red-800",children:"Danger Zone"}),e.jsx("p",{className:"text-sm text-red-600 mb-2",children:"This will cancel all seat bookings for this ticket."}),e.jsx(r,{onClick:ae,disabled:w,variant:"destructive",children:w?"Deleting...":"Delete Entire Ticket"})]})]}):e.jsx(q,{className:"h-32 w-full"}),e.jsx(ue,{children:e.jsx(r,{variant:"outline",onClick:()=>{d(!1),M(null)},children:"Close"})})]})})]})})};export{Re as default};
