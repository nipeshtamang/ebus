import{j as e,a5 as de,ae as ie,af as ce,ag as h}from"./ui-vendor-BPnJF_7J.js";import{r,u as oe}from"./react-vendor-Bgq3EpD8.js";import{C as z,a as V,b as $,d as q}from"./card-CoINBLpb.js";import{T as U}from"./table-mXJe5lnO.js";import{S as K}from"./skeleton-BmX8kKu8.js";import{E as me}from"./error-message-yDPqqqhZ.js";import{s as u}from"./superadminApi-Bft6DRZm.js";import{B as i}from"./index-C5bx2-Fn.js";import{I as Q}from"./input-CM-I2g3X.js";import{B as Z}from"./badge-CVKJlgmv.js";import{D as xe,b as he,c as pe,d as ue,e as je}from"./dialog-kKasmLKn.js";import{S as ge,a as fe,b as ye,c as Ne,d as be}from"./select-CUjAH3A_.js";import{f as C}from"./index-CaunA62S.js";import"./utils-vendor-Dq7h7Pqt.js";import"./query-vendor-B3bfG-l7.js";const we=20,ve=["BOOKED","CANCELLED","COMPLETED"],Oe=()=>{const[j,_]=r.useState([]),[G,D]=r.useState(!1),[I,E]=r.useState(null),[c,g]=r.useState(1),[A,J]=r.useState(1),[a,N]=r.useState({dateFrom:"",dateTo:"",routeId:"",userId:"",status:""}),[b,W]=r.useState(null),[d,F]=r.useState(null),[X,o]=r.useState(!1),[w,v]=r.useState(""),[M,B]=r.useState(!1),[S,f]=r.useState(!1),[k,P]=r.useState(null),L=oe(),m=r.useCallback(async()=>{D(!0),E(null);try{const s={page:c,limit:we,...a.dateFrom&&{dateFrom:a.dateFrom},...a.dateTo&&{dateTo:a.dateTo},...a.routeId&&{routeId:Number(a.routeId)},...a.userId&&{userId:Number(a.userId)},...a.status&&{status:a.status}},t=await u.getPaginatedTickets(s);_(t.data.tickets),J(t.data.totalPages)}catch(s){E(s instanceof Error?s.message:"Failed to load tickets")}finally{D(!1)}},[c,a]);r.useEffect(()=>{m()},[m,c]),r.useEffect(()=>{const t=new URLSearchParams(L.search).get("userId");t&&N(l=>({...l,userId:t}))},[L.search]);const Y=Array.from(j.flatMap(s=>s.bookings.map(t=>{var l;return(l=t.schedule)==null?void 0:l.route})).filter(s=>!!s).reduce((s,t)=>s.set(t.id,t),new Map).values()),ee=Array.from(j.flatMap(s=>s.bookings.map(t=>t.user)).filter(s=>!!s).reduce((s,t)=>s.set(t.id,t),new Map).values()),se=Array.from(new Set(j.flatMap(s=>s.bookings.map(t=>t.status)).filter(s=>!!s))),T=s=>{N(t=>({...t,[s.target.name]:s.target.value})),g(1)},H=s=>{N(t=>({...t,[s.target.name]:s.target.value})),g(1)},te=async s=>{var t,l;W(s),o(!0),F(null);try{const n=await u.getTicketById(s);F(n.data),v(((l=(t=n.data.bookings)==null?void 0:t[0])==null?void 0:l.status)||"")}catch{h.error("Failed to load ticket details"),o(!1)}},ae=async()=>{if(!(!b||!w||!k)){B(!0);try{await u.updateBookingStatus(k,{status:w,reason:"Status updated by admin"}),h.success("Booking status updated"),o(!1),m()}catch{h.error("Failed to update booking status")}finally{B(!1)}}},le=async s=>{if(window.confirm("Are you sure you want to cancel this seat booking?")){f(!0);try{await u.cancelBooking(s),h.success("Booking cancelled"),o(!1),m()}catch{h.error("Failed to cancel booking")}finally{f(!1)}}},re=async()=>{if(b&&window.confirm("Are you sure you want to delete this ticket? This will cancel all seat bookings. This cannot be undone.")){f(!0);try{await u.deleteTicket(b),h.success("Ticket deleted"),o(!1),m()}catch{h.error("Failed to delete ticket")}finally{f(!1)}}},p=new Map;j.forEach(s=>{if(!p.has(s.ticketNumber))p.set(s.ticketNumber,{...s});else{const t=p.get(s.ticketNumber);t.bookings=[...t.bookings,...s.bookings],p.set(s.ticketNumber,t)}});const R=Array.from(p.values());return e.jsx("div",{className:"w-full min-h-screen bg-gradient-to-br from-white to-teal-50",children:e.jsxs("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 mb-6",children:"Tickets"}),e.jsxs(z,{children:[e.jsx(V,{children:e.jsx($,{children:"Filters"})}),e.jsx(q,{children:e.jsxs("div",{className:"flex flex-wrap gap-4 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"Date From"}),e.jsx(Q,{type:"date",name:"dateFrom",value:a.dateFrom,onChange:H})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"Date To"}),e.jsx(Q,{type:"date",name:"dateTo",value:a.dateTo,onChange:H})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"Route"}),e.jsxs("select",{name:"routeId",value:a.routeId,onChange:T,className:"border rounded px-2 py-1",children:[e.jsx("option",{value:"",children:"All"}),Y.map(s=>e.jsxs("option",{value:s.id,children:[s.origin," - ",s.destination]},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"User"}),e.jsxs("select",{name:"userId",value:a.userId,onChange:T,className:"border rounded px-2 py-1",children:[e.jsx("option",{value:"",children:"All"}),ee.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.email,")"]},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs mb-1",children:"Status"}),e.jsxs("select",{name:"status",value:a.status,onChange:T,className:"border rounded px-2 py-1",children:[e.jsx("option",{value:"",children:"All"}),se.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsx(i,{onClick:m,variant:"outline",children:"Apply"})]})})]}),I&&e.jsx(me,{message:I,onRetry:m}),e.jsxs(z,{children:[e.jsx(V,{children:e.jsx($,{children:"Tickets"})}),e.jsxs(q,{children:[G?e.jsx(K,{className:"h-8 w-full"}):R.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No tickets found"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(U,{className:"min-w-[900px] border-separate border-spacing-y-2 border-spacing-x-4 rounded-xl bg-white shadow-md",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Ticket No"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Booking Date"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Departure Date"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"From - To"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Customer Name"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Customer Contact"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Booked Seats"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left font-semibold text-gray-700 whitespace-nowrap",children:"Actions"})]})}),e.jsx("tbody",{children:R.map(s=>{const t=s.bookings[0],l=t==null?void 0:t.schedule,n=l==null?void 0:l.route,x=t==null?void 0:t.user,y=s.bookings.map(ne=>{var O;return(O=ne.seat)==null?void 0:O.seatNumber}).filter(Boolean).join(", ");return e.jsxs("tr",{className:"even:bg-gray-50 hover:bg-teal-50 transition-colors rounded-xl",children:[e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:s.ticketNumber}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:t?C(new Date(t.createdAt),"yyyy-MM-dd HH:mm"):"-"}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:l?C(new Date(l.departure),"yyyy-MM-dd HH:mm"):"-"}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:n?`${n.origin} - ${n.destination}`:"-"}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:x?x.name:"-"}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:x?x.phoneNumber:"-"}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:y||"-"}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:e.jsx(Z,{children:(t==null?void 0:t.status)||"-"})}),e.jsx("td",{className:"px-6 py-4 bg-white rounded-lg shadow-sm whitespace-nowrap",children:e.jsxs(i,{size:"sm",variant:"outline",onClick:()=>te(s.id),children:[e.jsx(de,{className:"h-4 w-4 mr-1"}),"View"]})})]},s.id)})})]})}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsx(i,{size:"sm",variant:"outline",disabled:c===1,onClick:()=>g(c-1),children:"Previous"}),e.jsxs("span",{className:"px-2 py-1",children:["Page ",c," of ",A]}),e.jsx(i,{size:"sm",variant:"outline",disabled:c===A,onClick:()=>g(c+1),children:"Next"})]})]})]}),e.jsx(xe,{open:X,onOpenChange:o,children:e.jsxs(he,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsx(pe,{children:e.jsxs(ue,{children:["Ticket Details - ",d==null?void 0:d.ticketNumber]})}),d?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Ticket Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Ticket Number:"})," ",d.ticketNumber]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Total Seats:"})," ",d.bookings.length]}),d.qrCode&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"font-medium",children:"QR Code:"}),e.jsx("img",{src:d.qrCode,alt:"QR Code",className:"w-32 h-32 border rounded mt-2"})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"Booked Seats"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(U,{className:"min-w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"Seat"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Status"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Customer"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Route"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Departure"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Payment"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Actions"})]})}),e.jsx("tbody",{children:d.bookings.map(s=>{var t,l,n,x,y;return e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2",children:((t=s.seat)==null?void 0:t.seatNumber)||"-"}),e.jsx("td",{className:"px-4 py-2",children:e.jsx(Z,{children:s.status})}),e.jsxs("td",{className:"px-4 py-2",children:[((l=s.user)==null?void 0:l.name)||"-",e.jsx("br",{}),e.jsx("span",{className:"text-xs text-gray-500",children:((n=s.user)==null?void 0:n.phoneNumber)||"-"})]}),e.jsx("td",{className:"px-4 py-2",children:(x=s.schedule)!=null&&x.route?`${s.schedule.route.origin} → ${s.schedule.route.destination}`:"-"}),e.jsx("td",{className:"px-4 py-2",children:(y=s.schedule)!=null&&y.departure?C(new Date(s.schedule.departure),"yyyy-MM-dd HH:mm"):"-"}),e.jsx("td",{className:"px-4 py-2",children:s.payment?e.jsxs("div",{children:[e.jsxs("div",{children:["Rs. ",s.payment.amount]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[s.payment.method," -"," ",s.payment.status]})]}):"-"}),e.jsx("td",{className:"px-4 py-2",children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx(i,{size:"sm",variant:"outline",onClick:()=>{P(s.id),v(s.status)},children:e.jsx(ie,{className:"h-3 w-3"})}),e.jsx(i,{size:"sm",variant:"destructive",onClick:()=>le(s.id),disabled:S,children:e.jsx(ce,{className:"h-3 w-3"})})]})})]},s.id)})})]})})]}),k&&e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Edit Booking Status"}),e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-xs mb-1",children:"Status"}),e.jsxs(ge,{value:w,onValueChange:v,children:[e.jsx(fe,{children:e.jsx(ye,{placeholder:"Select status"})}),e.jsx(Ne,{children:ve.map(s=>e.jsx(be,{value:s,children:s},s))})]})]}),e.jsx(i,{onClick:ae,disabled:M,children:M?"Saving...":"Save Status"})]})]}),e.jsxs("div",{className:"bg-red-50 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold mb-2 text-red-800",children:"Danger Zone"}),e.jsx("p",{className:"text-sm text-red-600 mb-2",children:"This will cancel all seat bookings for this ticket."}),e.jsx(i,{onClick:re,disabled:S,variant:"destructive",children:S?"Deleting...":"Delete Entire Ticket"})]})]}):e.jsx(K,{className:"h-32 w-full"}),e.jsx(je,{children:e.jsx(i,{variant:"outline",onClick:()=>{o(!1),P(null)},children:"Close"})})]})})]})})};export{Oe as default};
