import{j as e,C as ee,R as se,a as U,T as q,B as te,b as ae,c as re,d as $,e as V,f as X,S as le,A as ne,M as oe,g as ce}from"./ui-vendor-BA4r0Vfc.js";import{a as r,u as ie,L as de}from"./react-vendor-CIX8g8kC.js";import{b as J,s as me,p as xe,B as z,C as m,a as x,c as h,d as u,I as he}from"./api-CX4-puwJ.js";import{B as ue}from"./badge-sFmlWEB5.js";import{A as G}from"./AdminLayout-Dhh5Bieh.js";import{S as ge}from"./skeleton-CJNjmkgT.js";import{E as fe,S as pe}from"./success-message-B9ZFEvVV.js";import{R as je}from"./index-DiI8FQ00.js";import"./utils-vendor-D-f4oM49.js";import"./query-vendor-COMjhFa0.js";function Ne(){const[y,d]=r.useState({totalBookings:0,totalSchedules:0,totalPayments:0,totalRevenue:0,pendingBookings:0,completedBookings:0,cancelledBookings:0}),[P,C]=r.useState([]),[g,B]=r.useState(!0),[v,l]=r.useState(!1),[L,E]=r.useState(null),c=r.useCallback(async()=>{try{E(null);const[n,i,p]=await Promise.allSettled([J.getAllBookings({page:1,limit:1e3}),me.getAllSchedules(),xe.getPaymentHistory({page:1,limit:1e3})]),j=n.status==="fulfilled"?n.value.data.bookings||n.value.data:[],O=i.status==="fulfilled"?i.value.data:[],S=p.status==="fulfilled"?p.value.data.payments||p.value.data:[];n.status==="rejected"&&console.error("Failed to fetch bookings:",n.reason),i.status==="rejected"&&console.error("Failed to fetch schedules:",i.reason),p.status==="rejected"&&console.error("Failed to fetch payments:",p.reason);const T=j.length,I=O.length,k=S.length,s=S.filter(t=>t.status==="COMPLETED").reduce((t,a)=>t+(a.amount||0),0),M=j.filter(t=>t.status==="PENDING").length,Q=j.filter(t=>t.status==="BOOKED"||t.status==="COMPLETED").length,W=j.filter(t=>t.status==="CANCELLED").length;d({totalBookings:T,totalSchedules:I,totalPayments:k,totalRevenue:s,pendingBookings:M,completedBookings:Q,cancelledBookings:W});const A={};j.forEach(t=>{const a=t.orderId?String(t.orderId):`noorder-${t.id}`;A[a]||(A[a]=[]),A[a].push(t)});const Y=Object.values(A).sort((t,a)=>{const D=new Date(t[0].createdAt).getTime();return new Date(a[0].createdAt).getTime()-D}).slice(0,5),K=[];Y.forEach(t=>{const a={};t.forEach(N=>{const b=N.schedule&&N.schedule.route?`${N.schedule.route.origin}->${N.schedule.route.destination}`:"unknown";a[b]||(a[b]=[]),a[b].push(N)});const D=Object.keys(a);Object.entries(a).forEach(([N,b],Z)=>{const o=b[0],H=b.map(w=>w.seat?.seatNumber).filter(w=>!!w),R=b.find(w=>w.payment&&w.payment.amount)?.payment,_=R?.amount||(o.schedule?.fare||0)*H.length;let F="Onward";D.length>1?F=Z===0?"Onward":"Return":D.length===1&&(F="Onward"),K.push({id:o.orderId||o.id,status:o.status,createdAt:o.createdAt,user:{name:o.user?.name||"N/A",phoneNumber:o.user?.phoneNumber||"N/A"},schedule:{departure:o.schedule?.departure||"",route:{origin:o.schedule?.route?.origin||"N/A",destination:o.schedule?.route?.destination||"N/A"},fare:o.schedule?.fare||0},seatNumbers:H,totalAmount:_,payment:R?{method:R.method||"N/A",status:R.status||"N/A"}:void 0,tripType:F})})}),C(K)}catch(n){console.error("Error fetching dashboard data:",n),E("Failed to load dashboard data. Please try again.")}},[]),f=r.useCallback(async()=>{l(!0),await c(),l(!1)},[c]);return r.useEffect(()=>{c().finally(()=>B(!1))},[c]),{stats:y,recentBookings:P,loading:g,error:L,refreshDashboard:f,refreshing:v,setRefreshing:l}}const De=()=>{const y=ie(),[d,P]=r.useState(""),[C,g]=r.useState(null),[B,v]=r.useState(null),{stats:l,recentBookings:L,loading:E,error:c,refreshDashboard:f,refreshing:n,setRefreshing:i}=Ne();r.useEffect(()=>{y.state?.success&&(g(y.state.message),window.history.replaceState({},document.title),f(),setTimeout(()=>{g(null)},5e3))},[y.state,f]);const p=async()=>{try{i(!0),await f(),g("Dashboard refreshed successfully!")}catch(s){console.error("Error refreshing dashboard:",s),v("Failed to refresh dashboard. Please try again.")}finally{i(!1)}},j=async()=>{try{i(!0);const s=await J.cleanupOrphanedBookings();await f();const M=s.data?.cleanedCount||0;g(`Database cleaned up successfully! Removed ${M} orphaned bookings.`)}catch(s){console.error("Error cleaning up:",s),v("Failed to cleanup database. Please try again.")}finally{i(!1)}},O=s=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"NPR",minimumFractionDigits:0}).format(s),S=s=>new Date(s).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),T=s=>{switch(s.toUpperCase()){case"BOOKED":case"COMPLETED":return"bg-green-100 text-green-800";case"PENDING":return"bg-yellow-100 text-yellow-800";case"CANCELLED":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},I=s=>{switch(s.toUpperCase()){case"BOOKED":case"COMPLETED":return e.jsx(V,{className:"h-4 w-4"});case"PENDING":return e.jsx($,{className:"h-4 w-4"});case"CANCELLED":return e.jsx(X,{className:"h-4 w-4"});default:return e.jsx($,{className:"h-4 w-4"})}},k=L.filter(s=>s.user?.name.toLowerCase().includes(d.toLowerCase())||s.user?.phoneNumber.includes(d)||s.schedule.route.origin.toLowerCase().includes(d.toLowerCase())||s.schedule.route.destination.toLowerCase().includes(d.toLowerCase()));return E?e.jsx(G,{children:e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-teal-50/30 to-cyan-50/30",children:e.jsx("div",{className:"w-full h-full p-4 md:p-6 lg:p-8",children:e.jsx(ge,{})})})}):c?e.jsx(G,{children:e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-teal-50/30 to-cyan-50/30 flex items-center justify-center p-4",children:e.jsx(fe,{message:c,onRetry:f})})}):e.jsx(G,{children:e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-teal-50/30 to-cyan-50/30",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-gradient-to-r from-white via-teal-50/50 to-cyan-50/50 backdrop-blur supports-[backdrop-filter]:bg-white/80 border-b border-teal-100 shadow-sm px-4 py-4 md:px-6 lg:px-8",children:e.jsx("div",{className:"max-w-7xl mx-auto",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex aspect-square size-10 items-center justify-center rounded-xl bg-gradient-to-br from-teal-500 via-cyan-500 to-blue-500 text-white shadow-lg",children:e.jsx(ee,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold bg-gradient-to-r from-teal-600 to-cyan-600 bg-clip-text text-transparent",children:"Admin Dashboard"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-600",children:"Overview of your bus booking system"})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(z,{variant:"outline",onClick:p,disabled:n,className:"border-teal-200 hover:bg-teal-50",children:[e.jsx(se,{className:`h-4 w-4 mr-2 ${n?"animate-spin":""}`}),"Refresh"]}),e.jsxs(z,{variant:"outline",onClick:j,disabled:n,className:"border-orange-200 hover:bg-orange-50 text-orange-600",children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Cleanup DB"]})]})]})})}),e.jsxs("div",{className:"w-full max-w-7xl mx-auto p-4 md:p-6 lg:p-8",children:[C&&e.jsx(pe,{message:C,onDismiss:()=>g(null),className:"mb-6"}),B&&e.jsx("div",{className:"mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(U,{className:"h-5 w-5 mr-2"}),B]}),e.jsx("button",{onClick:()=>v(null),className:"text-red-600 hover:text-red-800",children:"×"})]})}),c&&e.jsx("div",{className:"mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(U,{className:"h-5 w-5 mr-2"}),c]})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8",children:[e.jsxs(m,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-teal-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsxs(x,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(h,{className:"text-sm font-medium text-gray-600",children:"Total Bookings"}),e.jsx(q,{className:"h-4 w-4 text-teal-600"})]}),e.jsxs(u,{children:[e.jsx("div",{className:"text-2xl font-bold text-teal-600",children:l.totalBookings}),e.jsx("p",{className:"text-xs text-gray-500",children:"All time bookings"})]})]}),e.jsxs(m,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-teal-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsxs(x,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(h,{className:"text-sm font-medium text-gray-600",children:"Active Schedules"}),e.jsx(te,{className:"h-4 w-4 text-teal-600"})]}),e.jsxs(u,{children:[e.jsx("div",{className:"text-2xl font-bold text-teal-600",children:l.totalSchedules}),e.jsx("p",{className:"text-xs text-gray-500",children:"Available schedules"})]})]}),e.jsxs(m,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-teal-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsxs(x,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(h,{className:"text-sm font-medium text-gray-600",children:"Total Revenue"}),e.jsx(ae,{className:"h-4 w-4 text-teal-600"})]}),e.jsxs(u,{children:[e.jsx("div",{className:"text-2xl font-bold text-teal-600",children:O(l.totalRevenue)}),e.jsx("p",{className:"text-xs text-gray-500",children:"Completed payments"})]})]}),e.jsxs(m,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-teal-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsxs(x,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(h,{className:"text-sm font-medium text-gray-600",children:"Total Payments"}),e.jsx(re,{className:"h-4 w-4 text-teal-600"})]}),e.jsxs(u,{children:[e.jsx("div",{className:"text-2xl font-bold text-teal-600",children:l.totalPayments}),e.jsx("p",{className:"text-xs text-gray-500",children:"Payment transactions"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-6 md:mb-8",children:[e.jsxs(m,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-yellow-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsx(x,{className:"pb-2",children:e.jsxs(h,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx($,{className:"h-4 w-4 text-yellow-600"}),"Pending Bookings"]})}),e.jsxs(u,{children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:l.pendingBookings}),e.jsx("p",{className:"text-xs text-gray-500",children:"Awaiting confirmation"})]})]}),e.jsxs(m,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-green-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsx(x,{className:"pb-2",children:e.jsxs(h,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(V,{className:"h-4 w-4 text-green-600"}),"Completed Bookings"]})}),e.jsxs(u,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:l.completedBookings}),e.jsx("p",{className:"text-xs text-gray-500",children:"Successfully completed"})]})]}),e.jsxs(m,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-red-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsx(x,{className:"pb-2",children:e.jsxs(h,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4 text-red-600"}),"Cancelled Bookings"]})}),e.jsxs(u,{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:l.cancelledBookings}),e.jsx("p",{className:"text-xs text-gray-500",children:"Cancelled reservations"})]})]})]}),e.jsxs(m,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-teal-50/30",children:[e.jsx(x,{className:"bg-gradient-to-r from-teal-50 to-cyan-50 rounded-t-lg",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:[e.jsxs(h,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5 text-teal-600"}),"Recent Bookings"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2",children:[e.jsxs("div",{className:"relative w-full sm:w-auto",children:[e.jsx(le,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400"}),e.jsx(he,{placeholder:"Search bookings...",value:d,onChange:s=>P(s.target.value),className:"pl-10 w-full sm:w-64 border-teal-200 focus:border-teal-500"})]}),e.jsx(de,{to:je.BookingList,children:e.jsxs(z,{variant:"outline",size:"sm",className:"border-teal-200 hover:bg-teal-50 w-full sm:w-auto",children:["View All",e.jsx(ne,{className:"h-4 w-4 ml-2"})]})})]})]})}),e.jsx(u,{className:"p-4 md:p-6",children:k.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:d?"No bookings found matching your search.":"No recent bookings."}):e.jsx("div",{className:"space-y-4",children:k.map(s=>e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between p-4 border border-teal-100 rounded-lg hover:bg-teal-50/50 transition-all duration-200 gap-4",children:[e.jsx("div",{className:"flex items-start space-x-4",children:e.jsxs("div",{className:"flex flex-col min-w-0 flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:[e.jsx("span",{className:"font-medium truncate",children:s.user.name}),e.jsxs("span",{className:"text-sm text-gray-500",children:["(",s.user.phoneNumber,")"]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(oe,{className:"h-3 w-3 text-gray-400 flex-shrink-0"}),e.jsxs("span",{className:"text-sm text-gray-600 truncate",children:[s.schedule.route.origin," →"," ",s.schedule.route.destination]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(ce,{className:"h-3 w-3 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-500",children:S(s.schedule.departure)})]})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-teal-600",children:["Rs. ",s.totalAmount]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Seats: ",s.seatNumbers.join(", ")]}),s.payment&&e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[s.payment.method," -"," ",s.payment.status]})]}),e.jsx(ue,{className:T(s.status),children:e.jsxs("div",{className:"flex items-center gap-1",children:[I(s.status),s.status]})})]})]},s.id))})})]})]})]})})};export{De as default};
