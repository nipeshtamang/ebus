import{j as e,C as me,R as xe,a as $,T as ae,B as he,b as ue,c as ge,d as z,e as re,f as le,S as fe,A as je,M as pe,g as Ne}from"./ui-vendor-DMBPzNwu.js";import{r,u as be,L as we}from"./react-vendor-C8rorRqO.js";import{b as ne,s as ye,p as ve,B as G,C as x,a as h,c as u,d as g,I as Ce}from"./api-C7d73vgv.js";import{B as Be}from"./badge-BRWl9YMx.js";import{A as K}from"./AdminLayout-lzRtiUax.js";import{S as Ee}from"./skeleton-jijkxZMJ.js";import{E as Se,S as ke}from"./success-message-BsusCHyT.js";import{R as Ae}from"./index-DnDBnOSx.js";import"./utils-vendor-BIYRr1x_.js";import"./query-vendor-Dv9SXHgC.js";function De(){const[B,d]=r.useState({totalBookings:0,totalSchedules:0,totalPayments:0,totalRevenue:0,pendingBookings:0,completedBookings:0,cancelledBookings:0}),[O,S]=r.useState([]),[f,k]=r.useState(!0),[E,l]=r.useState(!1),[T,A]=r.useState(null),c=r.useCallback(async()=>{try{A(null);const[n,i,p]=await Promise.allSettled([ne.getAllBookings({page:1,limit:1e3}),ye.getAllSchedules(),ve.getPaymentHistory({page:1,limit:1e3})]),N=n.status==="fulfilled"?n.value.data.bookings||n.value.data:[],I=i.status==="fulfilled"?i.value.data:[],D=p.status==="fulfilled"?p.value.data.payments||p.value.data:[];n.status==="rejected"&&console.error("Failed to fetch bookings:",n.reason),i.status==="rejected"&&console.error("Failed to fetch schedules:",i.reason),p.status==="rejected"&&console.error("Failed to fetch payments:",p.reason);const M=N.length,F=I.length,R=D.length,s=D.filter(t=>t.status==="COMPLETED").reduce((t,a)=>t+(a.amount||0),0),m=N.filter(t=>t.status==="PENDING").length,y=N.filter(t=>t.status==="BOOKED"||t.status==="COMPLETED").length,oe=N.filter(t=>t.status==="CANCELLED").length;d({totalBookings:M,totalSchedules:F,totalPayments:R,totalRevenue:s,pendingBookings:m,completedBookings:y,cancelledBookings:oe});const P={};N.forEach(t=>{const a=t.orderId?String(t.orderId):`noorder-${t.id}`;P[a]||(P[a]=[]),P[a].push(t)});const ce=Object.values(P).sort((t,a)=>{const L=new Date(t[0].createdAt).getTime();return new Date(a[0].createdAt).getTime()-L}).slice(0,5),H=[];ce.forEach(t=>{const a={};t.forEach(b=>{const w=b.schedule&&b.schedule.route?`${b.schedule.route.origin}->${b.schedule.route.destination}`:"unknown";a[w]||(a[w]=[]),a[w].push(b)});const L=Object.keys(a);Object.entries(a).forEach(([b,w],ie)=>{var V,X,J,Q,W,Y,Z,_,ee,se;const o=w[0],q=w.map(C=>{var te;return(te=C.seat)==null?void 0:te.seatNumber}).filter(C=>!!C),v=(V=w.find(C=>C.payment&&C.payment.amount))==null?void 0:V.payment,de=(v==null?void 0:v.amount)||(((X=o.schedule)==null?void 0:X.fare)||0)*q.length;let U="Onward";L.length>1?U=ie===0?"Onward":"Return":L.length===1&&(U="Onward"),H.push({id:o.orderId||o.id,status:o.status,createdAt:o.createdAt,user:{name:((J=o.user)==null?void 0:J.name)||"N/A",phoneNumber:((Q=o.user)==null?void 0:Q.phoneNumber)||"N/A"},schedule:{departure:((W=o.schedule)==null?void 0:W.departure)||"",route:{origin:((Z=(Y=o.schedule)==null?void 0:Y.route)==null?void 0:Z.origin)||"N/A",destination:((ee=(_=o.schedule)==null?void 0:_.route)==null?void 0:ee.destination)||"N/A"},fare:((se=o.schedule)==null?void 0:se.fare)||0},seatNumbers:q,totalAmount:de,payment:v?{method:v.method||"N/A",status:v.status||"N/A"}:void 0,tripType:U})})}),S(H)}catch(n){console.error("Error fetching dashboard data:",n),A("Failed to load dashboard data. Please try again.")}},[]),j=r.useCallback(async()=>{l(!0),await c(),l(!1)},[c]);return r.useEffect(()=>{c().finally(()=>k(!1))},[c]),{stats:B,recentBookings:O,loading:f,error:T,refreshDashboard:j,refreshing:E,setRefreshing:l}}const ze=()=>{const B=be(),[d,O]=r.useState(""),[S,f]=r.useState(null),[k,E]=r.useState(null),{stats:l,recentBookings:T,loading:A,error:c,refreshDashboard:j,refreshing:n,setRefreshing:i}=De();r.useEffect(()=>{var s;(s=B.state)!=null&&s.success&&(f(B.state.message),window.history.replaceState({},document.title),j(),setTimeout(()=>{f(null)},5e3))},[B.state,j]);const p=async()=>{try{i(!0),await j(),f("Dashboard refreshed successfully!")}catch(s){console.error("Error refreshing dashboard:",s),E("Failed to refresh dashboard. Please try again.")}finally{i(!1)}},N=async()=>{var s;try{i(!0);const m=await ne.cleanupOrphanedBookings();await j();const y=((s=m.data)==null?void 0:s.cleanedCount)||0;f(`Database cleaned up successfully! Removed ${y} orphaned bookings.`)}catch(m){console.error("Error cleaning up:",m),E("Failed to cleanup database. Please try again.")}finally{i(!1)}},I=s=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"NPR",minimumFractionDigits:0}).format(s),D=s=>new Date(s).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),M=s=>{switch(s.toUpperCase()){case"BOOKED":case"COMPLETED":return"bg-green-100 text-green-800";case"PENDING":return"bg-yellow-100 text-yellow-800";case"CANCELLED":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},F=s=>{switch(s.toUpperCase()){case"BOOKED":case"COMPLETED":return e.jsx(re,{className:"h-4 w-4"});case"PENDING":return e.jsx(z,{className:"h-4 w-4"});case"CANCELLED":return e.jsx(le,{className:"h-4 w-4"});default:return e.jsx(z,{className:"h-4 w-4"})}},R=T.filter(s=>{var m,y;return((m=s.user)==null?void 0:m.name.toLowerCase().includes(d.toLowerCase()))||((y=s.user)==null?void 0:y.phoneNumber.includes(d))||s.schedule.route.origin.toLowerCase().includes(d.toLowerCase())||s.schedule.route.destination.toLowerCase().includes(d.toLowerCase())});return A?e.jsx(K,{children:e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-teal-50/30 to-cyan-50/30",children:e.jsx("div",{className:"w-full h-full p-4 md:p-6 lg:p-8",children:e.jsx(Ee,{})})})}):c?e.jsx(K,{children:e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-teal-50/30 to-cyan-50/30 flex items-center justify-center p-4",children:e.jsx(Se,{message:c,onRetry:j})})}):e.jsx(K,{children:e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 via-teal-50/30 to-cyan-50/30",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-gradient-to-r from-white via-teal-50/50 to-cyan-50/50 backdrop-blur supports-[backdrop-filter]:bg-white/80 border-b border-teal-100 shadow-sm px-4 py-4 md:px-6 lg:px-8",children:e.jsx("div",{className:"max-w-7xl mx-auto",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex aspect-square size-10 items-center justify-center rounded-xl bg-gradient-to-br from-teal-500 via-cyan-500 to-blue-500 text-white shadow-lg",children:e.jsx(me,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold bg-gradient-to-r from-teal-600 to-cyan-600 bg-clip-text text-transparent",children:"Admin Dashboard"}),e.jsx("p",{className:"text-xs md:text-sm text-gray-600",children:"Overview of your bus booking system"})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(G,{variant:"outline",onClick:p,disabled:n,className:"border-teal-200 hover:bg-teal-50",children:[e.jsx(xe,{className:`h-4 w-4 mr-2 ${n?"animate-spin":""}`}),"Refresh"]}),e.jsxs(G,{variant:"outline",onClick:N,disabled:n,className:"border-orange-200 hover:bg-orange-50 text-orange-600",children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"Cleanup DB"]})]})]})})}),e.jsxs("div",{className:"w-full max-w-7xl mx-auto p-4 md:p-6 lg:p-8",children:[S&&e.jsx(ke,{message:S,onDismiss:()=>f(null),className:"mb-6"}),k&&e.jsx("div",{className:"mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx($,{className:"h-5 w-5 mr-2"}),k]}),e.jsx("button",{onClick:()=>E(null),className:"text-red-600 hover:text-red-800",children:"×"})]})}),c&&e.jsx("div",{className:"mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx($,{className:"h-5 w-5 mr-2"}),c]})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8",children:[e.jsxs(x,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-teal-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(u,{className:"text-sm font-medium text-gray-600",children:"Total Bookings"}),e.jsx(ae,{className:"h-4 w-4 text-teal-600"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold text-teal-600",children:l.totalBookings}),e.jsx("p",{className:"text-xs text-gray-500",children:"All time bookings"})]})]}),e.jsxs(x,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-teal-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(u,{className:"text-sm font-medium text-gray-600",children:"Active Schedules"}),e.jsx(he,{className:"h-4 w-4 text-teal-600"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold text-teal-600",children:l.totalSchedules}),e.jsx("p",{className:"text-xs text-gray-500",children:"Available schedules"})]})]}),e.jsxs(x,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-teal-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(u,{className:"text-sm font-medium text-gray-600",children:"Total Revenue"}),e.jsx(ue,{className:"h-4 w-4 text-teal-600"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold text-teal-600",children:I(l.totalRevenue)}),e.jsx("p",{className:"text-xs text-gray-500",children:"Completed payments"})]})]}),e.jsxs(x,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-teal-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(u,{className:"text-sm font-medium text-gray-600",children:"Total Payments"}),e.jsx(ge,{className:"h-4 w-4 text-teal-600"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold text-teal-600",children:l.totalPayments}),e.jsx("p",{className:"text-xs text-gray-500",children:"Payment transactions"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-6 md:mb-8",children:[e.jsxs(x,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-yellow-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsx(h,{className:"pb-2",children:e.jsxs(u,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(z,{className:"h-4 w-4 text-yellow-600"}),"Pending Bookings"]})}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:l.pendingBookings}),e.jsx("p",{className:"text-xs text-gray-500",children:"Awaiting confirmation"})]})]}),e.jsxs(x,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-green-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsx(h,{className:"pb-2",children:e.jsxs(u,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4 text-green-600"}),"Completed Bookings"]})}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:l.completedBookings}),e.jsx("p",{className:"text-xs text-gray-500",children:"Successfully completed"})]})]}),e.jsxs(x,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-red-50/30 hover:shadow-2xl transition-all duration-300",children:[e.jsx(h,{className:"pb-2",children:e.jsxs(u,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4 text-red-600"}),"Cancelled Bookings"]})}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:l.cancelledBookings}),e.jsx("p",{className:"text-xs text-gray-500",children:"Cancelled reservations"})]})]})]}),e.jsxs(x,{className:"shadow-xl border-0 bg-gradient-to-br from-white to-teal-50/30",children:[e.jsx(h,{className:"bg-gradient-to-r from-teal-50 to-cyan-50 rounded-t-lg",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:[e.jsxs(u,{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-5 w-5 text-teal-600"}),"Recent Bookings"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2",children:[e.jsxs("div",{className:"relative w-full sm:w-auto",children:[e.jsx(fe,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400"}),e.jsx(Ce,{placeholder:"Search bookings...",value:d,onChange:s=>O(s.target.value),className:"pl-10 w-full sm:w-64 border-teal-200 focus:border-teal-500"})]}),e.jsx(we,{to:Ae.BookingList,children:e.jsxs(G,{variant:"outline",size:"sm",className:"border-teal-200 hover:bg-teal-50 w-full sm:w-auto",children:["View All",e.jsx(je,{className:"h-4 w-4 ml-2"})]})})]})]})}),e.jsx(g,{className:"p-4 md:p-6",children:R.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:d?"No bookings found matching your search.":"No recent bookings."}):e.jsx("div",{className:"space-y-4",children:R.map(s=>e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between p-4 border border-teal-100 rounded-lg hover:bg-teal-50/50 transition-all duration-200 gap-4",children:[e.jsx("div",{className:"flex items-start space-x-4",children:e.jsxs("div",{className:"flex flex-col min-w-0 flex-1",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:[e.jsx("span",{className:"font-medium truncate",children:s.user.name}),e.jsxs("span",{className:"text-sm text-gray-500",children:["(",s.user.phoneNumber,")"]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(pe,{className:"h-3 w-3 text-gray-400 flex-shrink-0"}),e.jsxs("span",{className:"text-sm text-gray-600 truncate",children:[s.schedule.route.origin," →"," ",s.schedule.route.destination]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(Ne,{className:"h-3 w-3 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-500",children:D(s.schedule.departure)})]})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-medium text-teal-600",children:["Rs. ",s.totalAmount]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Seats: ",s.seatNumbers.join(", ")]}),s.payment&&e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[s.payment.method," -"," ",s.payment.status]})]}),e.jsx(Be,{className:M(s.status),children:e.jsxs("div",{className:"flex items-center gap-1",children:[F(s.status),s.status]})})]})]},s.id))})})]})]})]})})};export{ze as default};
